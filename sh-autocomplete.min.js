/*!
 * shAutocomplete v0.3 (2017-11-02)
 * Autocomplete Bootstrap jQuery plugin
 * https://github.com/sunhater/shAutocomplete
 *
 * Copyright (c) 2017 Pavel Tzonkov <sunhater@sunhater.com>
 * Dual licensed under the MIT and GPL licenses
 */
(function(a){a.fn.autocomplete=function(e){var i={bootstrapVersion:3,timeout:1000,minChars:3,limit:null,cache:true,normalizeQuery:true,maxHeight:null,bottomSpace:20,requestUrl:"request.json?q=",debug:false,choose:function(j,k){},input:function(j){},searchStart:function(j){},searchEnd:function(j){},result:function(j){return j},transfer:function(j,k){a(j).val(a(k).text())},autofill:function(j,k){a.ajax({method:"get",dataType:"json",url:i.requestUrl+encodeURIComponent(j.value),success:function(l){k(i.result(l))},error:function(){k();if(i.debug){console.log("shAutofill search request failed!")}}})}};a.extend(true,i,e);var b=(i.bootstrapVersion==3);BOOTSTRAP4=(i.bootstrapVersion==4);if(!b&&!BOOTSTRAP4){alert("shAutocomplete: Bootstrap versions 3 and 4 are supported only!");return}var d=function(){var m=a(".shac.open .shac-menu, .shac-menu.show");if(!m.length){return}m.css({height:"auto"});var n=m.offset(),l=parseInt(m.css("margin-top")),p=m.outerHeight(),k=n.top+p+l+i.bottomSpace,o=Math.max(document.documentElement.clientHeight,window.innerHeight||0);if(k>=o){var j=o-n.top-l-i.bottomSpace-1;m.css({height:j})}},c=function(j){if(b){a(j).addClass("open")}else{a(j).addClass("show");a(j).find(".shac-menu").addClass("show")}},h=function(j){a(j).find(".shac-menu").scrollTop(0);a(j).find("input").removeData("active");if(b){a(j).removeClass("open")}else{a(j).removeClass("show");a(j).find(".shac-menu").removeClass("show")}},f=function(k,j){return b?'<li data-id="'+k+'" class="shac-item"><a>'+j+"</a></li>":'<li data-id="'+k+'" class="shac-item dropdown-item">'+j+"</li>"};a(window).off("click.shac").on("click.shac",function(){h(".shac")}).off("resize.shac").on("resize.shac",d);a("body").on("click.shac",".shac-menu, .shac input",function(j){j.stopPropagation()});var g=b?5:8;a(this).wrap('<div class="shac" />').after('<ul class="shac-menu dropdown-menu" />').each(function(){var j=0,m=[],l=false,k=a(this).parent(),n=k.find(".shac-menu");a(this).on("input.shac",function(){var o=this;h(k);j++;if(i.debug){console.log("Input: "+this.value)}i.input(this);setTimeout(function(){j--;if(j||l||(a(o).val().replace(/\s+/g,"").length<i.minChars)){return}l=true;a(o).prop({readonly:true});if(i.normalizeQuery){a(o).val(o.value.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," "))}i.searchStart(o);if(i.debug){console.log("Search: "+o.value)}var p=function(r){n.html("");if(i.maxHeight){n.css({maxHeight:i.maxHeight})}for(var q in r){n.append(f(q,r[q]))}n.find(".shac-item").click(function(){if(i.debug){console.log(a(this).data())}i.choose(o,this);h(k);i.transfer(o,this);a(o).focus()});c(k);setTimeout(d,0);l=false;a(o).prop({readonly:false});i.searchEnd(o)};if(i.cache&&(m[o.value]!==undefined)){if(!a.isEmptyObject(m[o.value])){p(m[o.value])}else{l=false;a(o).prop({readonly:false});i.searchEnd(o)}return}i.autofill(o,function(t){if((typeof t!=="object")||(t===undefined)||a.isEmptyObject(t)){l=false;a(o).prop({readonly:false});i.searchEnd(o);if(i.cache){m[o.value]=[]}return}if(i.limit){var s=t instanceof Array?t.length:Object.keys(t).length;if(s>i.limit){var r=0;for(var q in t){r++;if(r>i.limit){delete t[q]}}}}if(i.cache){m[o.value]=t}p(t)})},i.timeout)})}).keydown(function(x){var m,A=a(this).data(),l=a(this).next(),v=a(this).parent(),k=l.find(".shac-item").length,w=(x.keyCode===13),j=(x.keyCode===27),y=(x.keyCode===38),u=(x.keyCode===40);if(w){if(A.active===undefined){return true}var o=l.find(".shac-item").eq(A.active);if(i.debug){console.log(o.data())}i.choose(this,o);i.transfer(this,o);h(v);return false}if(j){h(v);return}if(y){if(A.active===undefined){m=k-1}else{m=A.active;m--;if(m<0){m=k-1}}}if(u){if(A.active===undefined){m=0}else{m=A.active;m++;if(m>=k){m=0}}}if(y||u){var q=l.find(".shac-item").eq(m),r=l.innerHeight(),p=l.scrollTop(),z=l.prop("scrollHeight"),B=q.position().top+p,t=q.outerHeight(),n=B+t+g,s=B-g;a(this).data({active:m});l.find(".shac-item").removeClass("key-active");q.addClass("key-active");if(z>r){l.scrollTop(y?s:(n-r))}return false}})}})(jQuery);