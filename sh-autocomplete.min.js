/*!
 * shAutocomplete v0.3 (2017-11-02)
 * Autocomplete Bootstrap jQuery plugin
 * https://github.com/sunhater/shAutocomplete
 *
 * Copyright (c) 2017 Pavel Tzonkov <sunhater@sunhater.com>
 * Dual licensed under the MIT and GPL licenses
 */
(function(a){a.fn.autocomplete=function(c){var e={bootstrapVersion:3,timeout:1000,minChars:3,limit:null,cache:true,normalizeQuery:true,maxHeight:null,bottomSpace:20,requestUrl:"request.json?q=",debug:false,choose:function(f,g){},input:function(f){},searchStart:function(f){},searchEnd:function(f){},result:function(f){return f},transfer:function(f,g){a(f).val(a(g).text())},autofill:function(f,g){a.ajax({method:"get",dataType:"json",url:e.requestUrl+encodeURIComponent(f.value),success:function(h){g(e.result(h))},error:function(){g();if(e.debug){console.log("shAutofill search request failed!")}}})}};a.extend(true,e,c);var b=(e.bootstrapVersion==3);BOOTSTRAP4=(e.bootstrapVersion==4);if(!b&&!BOOTSTRAP4){alert("shAutocomplete: Bootstrap versions 3 and 4 are supported only!");return}resize=function(){var i=a(".shac.open .shac-menu, .shac-menu.show");if(!i.length){return}i.css({height:"auto"});var j=i.offset(),h=parseInt(i.css("margin-top")),l=i.outerHeight(),g=j.top+l+h+e.bottomSpace,k=Math.max(document.documentElement.clientHeight,window.innerHeight||0);if(g>=k){var f=k-j.top-h-e.bottomSpace-1;i.css({height:f})}},open=function(f){if(b){a(f).addClass("open")}else{a(f).addClass("show");a(f).find(".shac-menu").addClass("show")}},close=function(f){a(f).find(".shac-menu").scrollTop(0);a(f).find("input").removeData("active");if(b){a(f).removeClass("open")}else{a(f).removeClass("show");a(f).find(".shac-menu").removeClass("show")}},renderOption=function(g,f){return b?'<li data-id="'+g+'" class="shac-item"><a href="javascript:;">'+f+"</a></li>":'<li data-id="'+g+'" class="shac-item dropdown-item">'+f+"</li>"};a(window).off("click.shac").on("click.shac",function(){close(".shac")}).off("resize.shac").on("resize.shac",resize);a("body").on("click.shac",".shac-menu, .shac input",function(f){f.stopPropagation()});var d=b?5:8;a(this).wrap('<div class="shac" />').after('<ul class="shac-menu dropdown-menu" />').each(function(){var f=0,i=[],h=false,g=a(this).parent(),j=g.find(".shac-menu");a(this).on("input.shac",function(){var k=this;close(g);f++;if(e.debug){console.log("Input: "+this.value)}e.input(this);setTimeout(function(){f--;if(f||h||(a(k).val().replace(/\s+/g,"").length<e.minChars)){return}h=true;a(k).prop({readonly:true});if(e.normalizeQuery){a(k).val(k.value.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," "))}e.searchStart(k);if(e.debug){console.log("Search: "+k.value)}var l=function(n){j.html("");if(e.maxHeight){j.css({maxHeight:e.maxHeight})}for(var m in n){j.append(renderOption(m,n[m]))}j.find(".shac-item").click(function(){if(e.debug){console.log(a(this).data())}e.choose(k,this);close(g);e.transfer(k,this);a(k).focus()});open(g);setTimeout(resize,0);h=false;a(k).prop({readonly:false});e.searchEnd(k)};if(e.cache&&(i[k.value]!==undefined)){if(!a.isEmptyObject(i[k.value])){l(i[k.value])}else{h=false;a(k).prop({readonly:false});e.searchEnd(k)}return}e.autofill(k,function(p){if((typeof p!=="object")||(p===undefined)||a.isEmptyObject(p)){h=false;a(k).prop({readonly:false});e.searchEnd(k);if(e.cache){i[k.value]=[]}return}if(e.limit){var o=p instanceof Array?p.length:Object.keys(p).length;if(o>e.limit){var n=0;for(var m in p){n++;if(n>e.limit){delete p[m]}}}}if(e.cache){i[k.value]=p}l(p)})},e.timeout)})}).keydown(function(t){var i,w=a(this).data(),h=a(this).next(),r=a(this).parent(),g=h.find(".shac-item").length,s=(t.keyCode===13),f=(t.keyCode===27),u=(t.keyCode===38),q=(t.keyCode===40);if(s){if(w.active===undefined){return true}var k=h.find(".shac-item").eq(w.active);if(e.debug){console.log(k.data())}e.choose(this,k);e.transfer(this,k);close(r);return false}if(f){close(r);return}if(u){if(w.active===undefined){i=g-1}else{i=w.active;i--;if(i<0){i=g-1}}}if(q){if(w.active===undefined){i=0}else{i=w.active;i++;if(i>=g){i=0}}}if(u||q){var m=h.find(".shac-item").eq(i),n=h.innerHeight(),l=h.scrollTop(),v=h.prop("scrollHeight"),x=m.position().top+l,p=m.outerHeight(),j=x+p+d,o=x-d;a(this).data({active:i});h.find(".shac-item").removeClass("key-active");m.addClass("key-active");if(v>n){h.scrollTop(u?o:(j-n))}return false}})}})(jQuery);