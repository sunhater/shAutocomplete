/*!
 * shAutocomplete v0.4 (2017-11-03)
 * Autocomplete Bootstrap jQuery plugin
 * https://github.com/sunhater/shAutocomplete
 *
 * Copyright (c) 2017 Pavel Tzonkov <sunhater@sunhater.com>
 * Dual licensed under the MIT and GPL licenses
 */
(function(a){a.fn.autocomplete=function(e){var i={request:{url:"",method:"get",dataType:"json",queryParam:"q"},timeout:1000,minChars:3,normalizeQuery:true,limit:null,cache:true,maxHeight:null,minHeight:82,bottomSpace:20,bootstrapVersion:3,debug:false,choose:function(j,k){},searchStart:function(j){},searchEnd:function(j){},input:function(j){},result:function(j){return j},transfer:function(j){return a(j).text()},autofill:function(j,k){g(j,k)}};a.extend(true,i,e);var b=(i.bootstrapVersion==3);BOOTSTRAP4=(i.bootstrapVersion==4);if(!b&&!BOOTSTRAP4){alert("shAutocomplete: Bootstrap versions 3 and 4 are supported only!");return}var g=function(j,m){var k=a.extend(true,{},i.request),l={};l[k.queryParam]=j.value;delete k.queryParam;if((k.data===undefined)||(typeof k.data!=="object")||(k.data!==Object(k.data))){k.data=l}else{a.extend(true,k.data,l)}k.success=function(n){m(i.result(n))};k.error=function(p,n,o){m();if(i.debug){console.log("shAutofill search request failed!",n,o,p)}};a.ajax(k)},d=function(){var l=a(".shac.open .shac-menu, .shac-menu.show");if(!l.length){return}l.css({height:"auto"});var k=parseInt(l.css("margin-top")),n=l.offset().top,p=l.outerHeight(),o=window.innerHeight,m=document.documentElement.clientHeight,j=o-n-k-i.bottomSpace;if(o<m){j+=a(document).scrollTop()}if(j<i.minHeight){j=i.minHeight}if(j<p){l.css({height:j})}},c=function(j){if(b){a(j).addClass("open")}else{a(j).addClass("show");a(j).find(".shac-menu").addClass("show")}},h=function(j){a(j).find(".shac-menu").scrollTop(0);a(j).find("input").removeData("active");if(b){a(j).removeClass("open")}else{a(j).removeClass("show");a(j).find(".shac-menu").removeClass("show")}},f=function(k,j){return b?'<li data-id="'+k+'" class="shac-item"><a>'+j+"</a></li>":'<li data-id="'+k+'" class="shac-item dropdown-item">'+j+"</li>"};a(window).off("click.shac").on("click.shac",function(){h(".shac")}).off("resize.shac scroll.shac").on("resize.shac scroll.shac",d);a("body").on("click.shac",".shac-menu, .shac input",function(j){j.stopPropagation()});a(this).attr({autocomplete:"off"}).wrap('<div class="shac" />').after('<ul class="shac-menu dropdown-menu" />').each(function(){var j=0,m=[],l=false,k=a(this).parent(),n=k.find(".shac-menu");a(this).on("input.shac",function(){var o=this;h(k);j++;if(i.debug){console.log("Input: "+this.value)}i.input(this);setTimeout(function(){j--;if(j||l||(a(o).val().replace(/\s+/g,"").length<i.minChars)){return}l=true;a(o).prop({readonly:true});if(i.normalizeQuery){a(o).val(o.value.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," "))}i.searchStart(o);if(i.debug){console.log("Search: "+o.value)}var p=function(r){n.html("");if(i.maxHeight){n.css({maxHeight:i.maxHeight})}for(var q in r){n.append(f(q,r[q]))}n.find(".shac-item").click(function(){if(i.debug){console.log(a(this).data())}i.choose(o,this);h(k);a(o).val(i.transfer(this)).focus()});c(k);setTimeout(d,0);l=false;a(o).prop({readonly:false});i.searchEnd(o)};if(i.cache&&(m[o.value]!==undefined)){if(!a.isEmptyObject(m[o.value])){p(m[o.value])}else{l=false;a(o).prop({readonly:false});i.searchEnd(o)}return}i.autofill(o,function(t){if((typeof t!=="object")||(t===undefined)||a.isEmptyObject(t)){l=false;a(o).prop({readonly:false});i.searchEnd(o);if(i.cache){m[o.value]=[]}return}if(i.limit){var s=t instanceof Array?t.length:Object.keys(t).length;if(s>i.limit){var r=0;for(var q in t){r++;if(r>i.limit){delete t[q]}}}}if(i.cache){m[o.value]=t}p(t)})},i.timeout)})}).keydown(function(x){var m,B=a(this).data(),l=a(this).next(),v=a(this).parent(),k=l.find(".shac-item").length,w=(x.keyCode===13),j=(x.keyCode===27),z=(x.keyCode===38),u=(x.keyCode===40);if(w){if(B.active===undefined){return true}var o=l.find(".shac-item").eq(B.active);if(i.debug){console.log(o.data())}i.choose(this,o);a(this).val(i.transfer(o));h(v);return false}if(j){h(v);return}if(z){if(B.active===undefined){m=k-1}else{m=B.active;m--;if(m<0){m=k-1}}}if(u){if(B.active===undefined){m=0}else{m=B.active;m++;if(m>=k){m=0}}}if(z||u){var y=b?5:8,q=l.find(".shac-item").eq(m),r=l.innerHeight(),p=l.scrollTop(),A=l.prop("scrollHeight"),C=q.position().top+p,t=q.outerHeight(),n=C+t+y,s=C-y;a(this).data({active:m});l.find(".shac-item").removeClass("key-active");q.addClass("key-active");if(A>r){l.scrollTop(z?s:(n-r))}return false}}).next(".shac-menu").on("mousewheel.shac DOMMouseScroll.shac",function(l){if(this.scrollHeight<a(this).innerHeight()){return}var m=l.wheelDelta||(l.originalEvent&&l.originalEvent.wheelDelta)||-l.detail,j=(this.scrollTop+a(this).outerHeight()-this.scrollHeight)>=0,k=this.scrollTop<=0;if((j&&(m<0))||(k&&(m>0))){l.preventDefault()}})}})(jQuery);